---
title: "Core_ERM_W2_notes"
author: "Xiaotian Tian"
format: pdf
editor: visual
---

# Week 1 Part 1: Research Plumbing 1

```{r}
options(crayon.enabled = FALSE) # suppress colorised warnings to be displayed correctly
gc() # garbage collection
rm(list = ls()) # clear variables
```

## Video

### Stroe and Read Data

-   `readr` package in tidyverse can load .csv or .tsv files smoothly

-   `readxl` imports .xls and .xlsx files

-   `haven` imports SAS, SPSS, and Stata files

Example use

```{r}
library(tidyverse)
```

Example of `read.csv()`

```{r}
url <- "https://ditraglia.com/data/height-handspan.csv"
height_handspan <- read.csv(url)

height_handspan
```

Example of `read_dta()`

```{r}
library(haven)
```

```{r}
url <- "https://ditraglia.com/data/lakisha_aer.dta"
lakisha <- read_dta(url)

lakisha
```

-   `getwd()` and `setwd()`

-   Beaware that, on Windows, we need to either use `/` or `\\`

    -   Better plan: use R Studio Projects and relative paths

## Wrangling Data

Sample data

```{r}
library(tidyverse)
set.seed(92815)
gradebook <- tibble(
  student_id = c(192297, 291857, 500286, 449192, 372152, 627561), 
  name = c('Alice', 'Bob', 'Charlotte', 'Dante', 
           'Ethelburga', 'Felix'),
  quiz1 = round(rnorm(6, 65, 15)),
  quiz2 = round(rnorm(6, 88, 5)),
  quiz3 = round(rnorm(6, 75, 10)),
  midterm1 = round(rnorm(6, 75, 10)),
  midterm2 = round(rnorm(6, 80, 8)), 
  final = round(rnorm(6, 78, 11)))
gradebook
```

### tidyselect

`tidyselect` arguments in `dplyr`

Example (easier ones)

```{r}
gradebook |>
  select(starts_with("quiz"))
```

```{r}
gradebook |>
  select(ends_with("2"))
```

```{r}
gradebook |>
  select(contains("iz"))
```

```{r}
gradebook |>
  select(num_range("quiz", 2:3)) # select based on both a prefix and a numeric range
```

We can even use regular expressions!!

```{r}
gradebook |>
  select(matches("quiz[0-9]+"))
```

`where()` takes a function as input and applies it to every column of th tibble and returns those where the function returns `TRUE`

```{r}
gradebook |>
  select(where(is.numeric))
```

### Column-wise Operations

```{r}
gradebook |>
  summarise(across(starts_with("quiz"), mean, .names = "{.col}_avg"))
```

`summarise(across(      ))`

-   1st argument: `.cols` specifies columns to work with

    -   specify explicitly using a vector `c("col1", "col2")`

    -   use `tidyselect`

-   2nd argument: `.fns` specifies function(s) to apply

-   3rd argument (optional): `.names()` sets rule for naming transformed columns, using syntax from the `glue` package

We can supply a custom function:

```{r}
zscore <- function(x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

gradebook |>
  summarise(across(starts_with("quiz"), zscore, .names = "{.col}_zscore")) |>
  select(ends_with("zscore"))
```

We can even supply a list of functions:

```{r}
mean_var <- list(
  mean = \(x) mean(x, na.rm = TRUE),
  var = \(x) var(x, na.rm = FALSE)
)

gradebook |>
  summarise(across(
    starts_with("quiz"),
    mean_var,
    .names = "{.col}_{.fn}"
  ))
```

Exercise C

```{r}
# 1
gradebook |>
  summarise(across(
    matches("quiz[\\d]?"),
    sd,
    .names = "{.col}_sd"
  ))
```

```{r}
# 2
starwars |>
  summarise(across(
    everything(),
    n_distinct,
    .names = "n_{.col}s"
  ))
```

```{r}
# 3
starwars |>
  group_by(homeworld) |>
  filter(n() >= 2) |>
  summarise(across(
    c(sex, species, eye_color),
    n_distinct,
    .names = "n_distinct_{.col}"
  ))
```

```{r}
# 4
starwars |>
  group_by(species) |>
  filter(n() >= 2) |>
  summarise(across(
    where(~ typeof(.) %in% c("integer", "double")), # ~ starts an anonymous function (like lambda in python) and . refers to the column being tested
    median,
    na.rm = TRUE,
    .name = "{.col}_median"
  ))
```

```{r}
# 5
starwars |>
  summarise(across(
    where(~ typeof(.) %in% c("integer", "double")),
    list("sd" = sd, "iqr" = IQR),
    na.rm = TRUE,
    .names = "{.col}_{.fn}"
  ))
```

### Recode

```{r}
star <- read_csv('https://ditraglia.com/data/STAR.csv')
```

Use `case_match()` from `dplyr` to recode values

```{r}
star <- star |>
  mutate(classtype = case_match(classtype,
                                1 ~ "small",
                                2 ~ "regular",
                                3 ~ "regular+aid"))
```

```{r}
star
```

## Producing Tables

Use reproducible tools like `knitr::kable`, `gt` and `modelsummary` to generate and format tables, and include them in *any* document format.

-   Today: [`datasummary`](https://vincentarelbundock.github.io/modelsummary/articles/datasummary.html) and [`knitr::kable`](https://bookdown.org/yihui/rmarkdown-cookbook/kable.html)

-   Future lectures: [`modelsummary`](https://vincentarelbundock.github.io/modelsummary/articles/modelsummary.html)

-   Some prefer [`stargazer`](https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf). You can use this if you prefer.

-   For the ultimate in precision table creation, try [`gt`](https://gt.rstudio.com/).

```{r}
library(modelsummary)
```

```{r}
datasummary_skim(star)
```

We can compare summary statistics across categories defined by a "grouping" variable with syntax `datasummay_table( ~ [GROUPING_VAR], data)`

```{r}
star |>
  select(yearssmall, g4math, g4reading, classtype) |>
  datasummary_balance(~ classtype, data = _)
```

Customise table with `knitr::kable`:

```{r}
my_table <- star |>
  group_by(classtype) |>
  summarise(across(
    starts_with("g4"),
    \(x) mean(x, na.rm = TRUE),
    .names = "{.col}_avg"
  ))

my_table |>
  knitr::kable(
    digits = 1,
    caption = "Average grade 4 test scores",
    col.names = c("Class Type", "Math", "Reading")
    )
```

# Week 1 Part 2: Linear Regression

## Linear Regression Basics

```{r}
gc() # garbage collection
rm(list = ls()) # clear variables
library(tidyverse)
kids <- read_csv('https://ditraglia.com/data/child_test_data.csv')
kids
```

Clean up with [**`janitor`**](https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html)**`:`**

```{r}
library(janitor)
kids <- clean_names(kids)
kids
```

Linear Regression with `lm([FORMULA], [DATAFRAME])`:

Formula Syntax:

-   `~` to separate LHS from RHS: Y from X

-   `+` to separate RHS variables: X1 from X2

```{r}
lm(kid_score ~ mom_iq + mom_age, data = kids)
```

Plot the regression line

```{r}
kids |>
  ggplot(aes(
    x = mom_iq, y = kid_score
  )) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Mom's IQ Score") +
  ylab("Child's Test Score (Age 3)")
```

Getting more from `lm()`

```{r}
reg1 <- lm(kid_score ~ mom_iq, kids)
str(reg1)
```

```{r}
coef(reg1)
```

```{r}
resid(reg1)[1:10] # only display the first 10
```

```{r}
fitted.values(reg1)[1:10] # only display the first 10
```

Summarising the output of `lm()`

```{r}
summary(reg1)
```

Looking inside `summary()`

```{r}
str(summary(reg1))
```

Accessing specific result from `summary()`

```{r}
summary(reg1)$r.squared
```

## Tidying up with `broom()`

Tidying up with `broom()` : `tidy()` returns a tibble with estimates, SEs, etc.

```{r}
library(broom)
tidy(reg1)
```

`glance()` returns a tibble with measurement of "model fit"

```{r}
glance(reg1)
```

and `broom` plays nicely with `dyplr`

```{r}
reg1 |>
  tidy() |>
  filter(term == "mom_iq") |>
  pull(p.value)
```

`augment()` ensembles a number of figures

```{r}
augment(reg1, kids)
```

## Dummy Variables

We can recode a variable into 2-category str variable and R will construct the dummy for us

```{r}
kids <- kids |>
  mutate(mom_education = if_else(mom_hs == 1, "HS", "NoHS"))

lm(kid_score ~ mom_education, kids)
```

Designate the baseline category:

```{r}
kids <- kids |>
  mutate(mom_education = fct_relevel(mom_education, "NoHS"))

lm(kid_score ~ mom_education, kids)
```

To generate a dummy for every value of a variable, use `factor([variable])` in your formula.

## R-formula

More on **R-formula**:

-   `y ~ x` is an R **formula**; use to specify a statistical model

-   Within a formula, certain characters have a special meaning

-   You’ve already met `~` and `+`

-   The rest are `.`, `-`, `1`, `:`, `*`, `^`, and `I()`.

-   `^` and `*` are more exotic; I’ll skip them here

-   See my [R Formula Cheatsheet](https://www.econometrics.blog/post/the-r-formula-cheatsheet/) for full details.

Regressing one variable on all other variables using `.`:

```{r}
lm(kid_score ~ ., kids)
```

Removing predictors with `-` :

```{r}
lm(kid_score ~ . - mom_hs, kids)
```

Remove the intercept by `-`

`1`:

```{r}
lm(kid_socre ~ . - 1, kids)
```

Regress only on an intercept:

```{r}
lm(kid_score ~ 1, kids)
```

Remove the intercept when having categorical dummies:

```{r}
lm(kid_score ~ mom_education - 1, kids)
```

Formulating new predictors:

```{r}
new_kids <- kids |>
  mutate(log_kid_score = log(kid_score),
         mom_age_sq = mom_age^2)
lm(log_kid_score ~ mom_age + mom_age_sq, new_kids)
```

A cleaner approach:

```{r}
lm(log(kid_score) ~ mom_age + I(mom_age^2), kids)
```

Adding interactions with `:`:

```{r}
lm(kid_score ~ mom_age:mom_iq, kids)
```

## Predicted Values

**Syntax**: `predict(object, newdata)`

```{r}
reg2 <- lm(kid_score ~ mom_iq * mom_education, kids) 
new_kids <- data.frame(mom_iq = c(100, 120, 80), 
                       mom_education = c('NoHS', 'HS', 'HS'))

predict(reg2, new_kids)
```

Predicting with `augment()`:

```{r}
augment(reg2, newdata = new_kids) |>
  rename(kid_score_pred = .fitted)
```

## Testing Linear Restrictions

`linearHypothesis()` from `car` provides F-test.

**Some Warnings**

-   Null hypothesis significance testing (NHST) is rarely the right tool for the job in applied work.

-   Have you see the memo on [p-values](https://www.amstat.org/asa/files/pdfs/P-ValueStatement.pdf)?

-   **Statistical Inference - Defense Against the Dark Arts**

-   See also: [FF-tests, R2R2 and Other Distractions](https://www.stat.cmu.edu/~cshalizi/mreg/15/lectures/10/lecture-10.pdf)

-   Today: assume *homoskedasticity*.

Testing $\beta_0 = \beta_1 = 1$:

```{r}
library(car)
linearHypothesis(reg1, c("mom_iq = 1", "(Intercept) = 1"))
```

Variants of the test:

Use the asymptotic $\chi^2$ distribution:

```{r}
linearHypothesis(reg1, c("mom_iq = 1", "(Intercept) = 1"), test = "Chisq")
```

## Making Nice Regression Tables

`modelsummary()` function for regression tables

```{r}
library(modelsummary)
```

```{r}
reg_pooled <- lm(kid_score ~ mom_iq, kids)
reg_hs_dummy <- lm(kid_score ~ mom_iq + mom_hs, kids)
reg_interact <- lm(kid_score ~ mom_iq * mom_hs, kids)
```

```{r}
modelsummary(reg_pooled)
```

Clean up results:

```{r}
modelsummary(reg_pooled, gof_omit = 'Log.Lik|R2 Adj.|AIC|BIC|F', fmt = 2, 
             title = 'Regression results for kids dataset', 
             notes = 'Source: all data were fabricated by the authors.') 
```

Results of Several Regressions:

```{r}
kids_regressions <- list(reg_pooled, reg_hs_dummy, reg_interact)
modelsummary(kids_regressions, gof_omit = 'Log.Lik|R2 Adj.|AIC|BIC|F', fmt = 2)
```

\

## Misc

What will happen if regress $Y$ on $\hat{Y}$ ?

-   Intercept 0, slope 1

-   We can write out the objective function and see only intercept 0, slope 1 can be optimal
