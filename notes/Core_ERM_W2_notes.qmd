---
title: "Core_ERM_W2_notes"
author: "Xiaotian Tian"
format: pdf
editor: visual
---

# Week 1 Part 1: Research Plumbing 1

```{r}
options(crayon.enabled = FALSE) # suppress colorised warnings to be displayed correctly
gc() # garbage collection
rm(list = ls()) # clear variables
```

## Video

### Stroe and Read Data

-   `readr` package in tidyverse can load .csv or .tsv files smoothly

-   `readxl` imports .xls and .xlsx files

-   `haven` imports SAS, SPSS, and Stata files

Example use

```{r}
library(tidyverse)
```

Example of `read.csv()`

```{r}
url <- "https://ditraglia.com/data/height-handspan.csv"
height_handspan <- read.csv(url)

height_handspan
```

Example of `read_dta()`

```{r}
library(haven)
```

```{r}
url <- "https://ditraglia.com/data/lakisha_aer.dta"
lakisha <- read_dta(url)

lakisha
```

-   `getwd()` and `setwd()`

-   Beaware that, on Windows, we need to either use `/` or `\\`

    -   Better plan: use R Studio Projects and relative paths

## Wrangling Data

Sample data

```{r}
library(tidyverse)
set.seed(92815)
gradebook <- tibble(
  student_id = c(192297, 291857, 500286, 449192, 372152, 627561), 
  name = c('Alice', 'Bob', 'Charlotte', 'Dante', 
           'Ethelburga', 'Felix'),
  quiz1 = round(rnorm(6, 65, 15)),
  quiz2 = round(rnorm(6, 88, 5)),
  quiz3 = round(rnorm(6, 75, 10)),
  midterm1 = round(rnorm(6, 75, 10)),
  midterm2 = round(rnorm(6, 80, 8)), 
  final = round(rnorm(6, 78, 11)))
gradebook
```

### tidyselect

`tidyselect` arguments in `dplyr`

Example (easier ones)

```{r}
gradebook |>
  select(starts_with("quiz"))
```

```{r}
gradebook |>
  select(ends_with("2"))
```

```{r}
gradebook |>
  select(contains("iz"))
```

```{r}
gradebook |>
  select(num_range("quiz", 2:3)) # select based on both a prefix and a numeric range
```

We can even use regular expressions!!

```{r}
gradebook |>
  select(matches("quiz[0-9]+"))
```

`where()` takes a function as input and applies it to every column of th tibble and returns those where the function returns `TRUE`

```{r}
gradebook |>
  select(where(is.numeric))
```

### Column-wise Operations

```{r}
gradebook |>
  summarise(across(starts_with("quiz"), mean, .names = "{.col}_avg"))
```

`summarise(across(      ))`

-   1st argument: `.cols` specifies columns to work with

    -   specify explicitly using a vector `c("col1", "col2")`

    -   use `tidyselect`

-   2nd argument: `.fns` specifies function(s) to apply

-   3rd argument (optional): `.names()` sets rule for naming transformed columns, using syntax from the `glue` package

We can supply a custom function:

```{r}
zscore <- function(x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

gradebook |>
  summarise(across(starts_with("quiz"), zscore, .names = "{.col}_zscore")) |>
  select(ends_with("zscore"))
```

We can even supply a list of functions:

```{r}
mean_var <- list(
  mean = \(x) mean(x, na.rm = TRUE),
  var = \(x) var(x, na.rm = FALSE)
)

gradebook |>
  summarise(across(
    starts_with("quiz"),
    mean_var,
    .names = "{.col}_{.fn}"
  ))
```

Exercise C

```{r}
# 1
gradebook |>
  summarise(across(
    matches("quiz[\\d]?"),
    sd,
    .names = "{.col}_sd"
  ))
```

```{r}
# 2
starwars |>
  summarise(across(
    everything(),
    n_distinct,
    .names = "n_{.col}s"
  ))
```

```{r}
# 3
starwars |>
  group_by(homeworld) |>
  filter(n() >= 2) |>
  summarise(across(
    c(sex, species, eye_color),
    n_distinct,
    .names = "n_distinct_{.col}"
  ))
```

```{r}
# 4
starwars |>
  group_by(species) |>
  filter(n() >= 2) |>
  summarise(across(
    where(~ typeof(.) %in% c("integer", "double")), # ~ starts an anonymous function (like lambda in python) and . refers to the column being tested
    median,
    na.rm = TRUE,
    .name = "{.col}_median"
  ))
```

```{r}
# 5
starwars |>
  summarise(across(
    where(~ typeof(.) %in% c("integer", "double")),
    list("sd" = sd, "iqr" = IQR),
    na.rm = TRUE,
    .names = "{.col}_{.fn}"
  ))
```

### Recode

```{r}
star <- read_csv('https://ditraglia.com/data/STAR.csv')
```

Use `case_match()` from `dplyr` to recode values

```{r}
star <- star |>
  mutate(classtype = case_match(classtype,
                                1 ~ "small",
                                2 ~ "regular",
                                3 ~ "regular+aid"))
```

```{r}
star
```

## Producing Tables

Use reproducible tools like `knitr::kable`, `gt` and `modelsummary` to generate and format tables, and include them in *any* document format.

-   Today: [`datasummary`](https://vincentarelbundock.github.io/modelsummary/articles/datasummary.html) and [`knitr::kable`](https://bookdown.org/yihui/rmarkdown-cookbook/kable.html)

-   Future lectures: [`modelsummary`](https://vincentarelbundock.github.io/modelsummary/articles/modelsummary.html)

-   Some prefer [`stargazer`](https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf). You can use this if you prefer.

-   For the ultimate in precision table creation, try [`gt`](https://gt.rstudio.com/).

```{r}
library(modelsummary)
```

```{r}
datasummary_skim(star)
```

We can compare summary statistics across categories defined by a "grouping" variable with syntax `datasummay_table( ~ [GROUPING_VAR], data)`

```{r}
star |>
  select(yearssmall, g4math, g4reading, classtype) |>
  datasummary_balance(~ classtype, data = _)
```

Customise table with `knitr::kable`:

```{r}
my_table <- star |>
  group_by(classtype) |>
  summarise(across(
    starts_with("g4"),
    \(x) mean(x, na.rm = TRUE),
    .names = "{.col}_avg"
  ))

my_table |>
  knitr::kable(
    digits = 1,
    caption = "Average grade 4 test scores",
    col.names = c("Class Type", "Math", "Reading")
    )
```
